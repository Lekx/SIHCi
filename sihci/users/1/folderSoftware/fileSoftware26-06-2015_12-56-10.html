<?php

$zip_name= date('Y-m-d').'.zip';
$zip_directory='/var/www/http/SIHCi/sihci/backups';
$zip= new zip($zip_name, $zip_directory);
$zip->add_directory('files');
$zip->save();

$zip_path = $zip->get_zip_path();


header("Pragma: public" );
header("Expires: 0" );
header("Cache-Control: must-revalidate, post-check=0, pre-check=0");
header("Cache-Control: public");
header("Content-Description: File Transfer");
header("Content-type: application/zip");
header("Content-Disposition: attachment; filename=$zip_name");
header("Content-Transfer-Encoding: binary" );
header("Content-Length:".filesize($zip_path) );

readfile( $zip_path );


class zip
{
   private $zip;
   public function __construct($file_name, $zip_directory)
   {
        $this->zip = new ZipArchive();
        $this->path =$zip_directory.$file_name.'.zip';
        $this->zip->open( $this->path, ZipArchive::CREATE );
    }
      
   /**
     * Get the absolute path to the zip file
     * @return string
     */
    public function get_zip_path()
    {
        return $this->path;
    }   
       
    /**
     * Add a directory to the zip
     * @param $directory
     */
    public function add_directory( $directory )
    {
        if(is_dir($directory) && $handle = opendir($directory))
        {
            $this->zip->addEmptyDir($directory);
            while(($file = readdir($handle)) !== false)
            {
                if (!is_file($directory.'/'.$file))
                {
                    if (!in_array($file, array('.', '..')))
                    {
                        $this->add_directory($directory.'/'.$file );
                    }
                }
                else
                {
                    $this->add_file($directory.'/'.$file);                
                }

            }
        }
    }
   
    /**
     * Add a single file to the zip
     * @param string $path
     */
    public function add_file($path)
    {
        $this->zip->addFile($path,$path);
    }
   
    /**
     * Close the zip file
     */
    public function save()
    {
        $this->zip->close();
    }
}

?>





<?php 

   $archive_name = date('Y-m-d').".zip"; 
   $archive_folder = "../backups/files/users"; 

    $zip = new ZipArchive;
    if ($zip -> open($archive_name, ZipArchive::CREATE) === true)
    {
        $dir = preg_replace('/[\/]{2,}/', '/', $archive_folder."/");
       
        $dirs = array($dir);
        while (count($dirs))
        {
            $dir = current($dirs);
            $zip -> addEmptyDir($dir);
           
            $dh = opendir($dir);
            while($file = readdir($dh))
            {
                if ($file != '.' && $file != '..')
                {
                    if (is_file($file))
                        $zip -> addFile($dir.$file, $dir.$file);
                    elseif (is_dir($file))
                        $dirs[] = $dir.$file.".pdf";
                }
            }
            closedir($dh);
            array_shift($dirs);
        }       
        $zip -> close(); 
    }
    else 
    {
        echo "ERROR al Descargar" ;
    }
    

    header("Content-type: application/zip"); 
    header("Content-Disposition: attachment; filename=$archive_name");
    header("Content-length: " . filesize($archive_name));
    header("Pragma: no-cache"); 
    header("Expires: 0"); 
    readfile("$archive_name");

?>
